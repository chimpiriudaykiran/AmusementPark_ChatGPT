<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Meta tags -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="" />
    <meta name="author" content="" />

    <title>Fantasy Island - Signup</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <!-- Custom fonts -->
    <link href="/static/vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css" />
    <link href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i" rel="stylesheet" />

    <!-- Custom styles -->
    <link href="../static/css/sb-admin-2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="./static/css/style.css" type="text/css" />

    <!-- Ionic icons -->
    <link href="https://unpkg.com/ionicons@4.2.0/dist/css/ionicons.min.css" rel="stylesheet" />

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700,900" rel="stylesheet" />

    <!-- Custom CSS -->
    <style>
        .icon-vector {
            display: flex;
            justify-content: center;
            width: 20px;
            height: 20px;
            margin: 5px;
            filter: brightness(0.85);
        }

        .icon-background {
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 20%;
            /* for a circular background */
        }
    </style>
</head>

<body>

    <!-- Navbar -->
    <!-- Your navbar code goes here -->

    <!-- Main content -->
    <div class="container" style="padding-top: 30px; width: 40%">
        <div class="card o-hidden border-0 shadow-lg my-5">
            <div class="card-body p-0">
                <div class="p-5">
                    <div class="text-center">
                        <h1 class="h4 text-gray-900 mb-4">Welcome Back</h1>
                    </div>
                    <form class="user" id="loginForm">
                        <div class="form-group">
                            <input type="email" class="form-control form-control-user" id="exampleInputEmail" placeholder="Enter Email ID" name="emailid" />
                        </div>
                        <div class="form-group">
                            <input type="password" class="form-control form-control-user" id="exampleInputPassword" placeholder="Password" name="password" />
                            <label for="exampleInputPassword">Password</label>
                        </div>
                        <div class="form-group">
                            <div class="custom-control custom-checkbox small">
                                <input type="checkbox" class="custom-control-input" id="customCheck" name="remember" />
                                <label class="custom-control-label" for="customCheck">Remember Me</label>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Login</button>
                    </form>
                    <hr />
                    <div class="text-center">
                        <a class="small" href="forgot-password">Forgot Password?</a>
                    </div>
                    <div class="text-center">
                        <a class="small" href="signup">New User? Signup here!</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap core JavaScript -->
    <script src="/static/vendor/jquery/jquery.min.js"></script>
    <script src="/static/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="/static/vendor/jquery-easing/jquery.easing.min.js"></script>
    <script src="../static/js/sb-admin-2.min.js"></script>

    <!-- Your additional scripts go here -->
    <script>
        const alertPlaceholder = document.getElementById('liveAlertPlaceholder')
        const appendAlert = (message, type) => {
            const wrapper = document.createElement('div')
            wrapper.innerHTML = [
                `<div class="alert alert-${type} alert-dismissible" role="alert">`,
                `   <div>${message}</div>`,
                '   <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>',
                '</div>'
            ].join('');
            alertPlaceholder.innerText = '';
            alertPlaceholder.append(wrapper)
        }

        document
            .getElementById("loginForm")
            .addEventListener("submit", function (event) {
                event.preventDefault(); // Prevent the form from submitting normally

                // Collect form data
                const formData = new FormData(this);

                // Send POST request to backend
                fetch("/validate_credentials", {
                    method: "POST",
                    body: JSON.stringify(Object.fromEntries(formData)), // Convert FormData to JSON object
                    headers: {
                        "Content-Type": "application/json",
                    },
                })
                    .then((response) => {
                        if (!response.ok) {
                            return response.json().then((responsetext) => {
                                console.error(responsetext.message);
                                appendAlert(responsetext.message, 'danger');
                                throw new Error(responsetext.message);
                            });
                        } else {
                            return response.json();
                        }

                    })
                    .then((data) => {
                        // Handle successful response
                        console.log(data.message);
                        const userDetails = {
                            username: formData.get("username"),
                        }
                        const expirationTime = new Date(); // Set expiration time (e.g., 1 hour from now)
                        expirationTime.setHours(expirationTime.getHours() + 1); // Set expiration time to 1 hour from now
                        // Store user details and expiration time in a single object
                        const userData = {
                            userDetails: userDetails,
                            expirationTime: expirationTime.toUTCString(), // Convert expiration time to UTC string
                        };
                        // Convert user data to JSON string and set it as cookie value
                        document.cookie = `userData=${JSON.stringify(userData)}; expires=${expirationTime.toUTCString()}; path=/`;
                        // Redirect user to homepage
                        window.location.href = "/";
                    })
            });
    </script>
    <script>
        window.onload = function () {
            // Function to check if the user is logged in
            function isLoggedIn() {
                // Get all cookies
                const cookies = document.cookie.split(';');
                // Loop through each cookie to find userData
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Check if the cookie contains 'userData'
                    if (cookie.startsWith('userData=')) {
                        // If 'userData' is found, parse it and check expiration time
                        const userDataString = cookie.substring('userData='.length, cookie.length);
                        const userData = JSON.parse(decodeURIComponent(userDataString));
                        const expirationTime = new Date(userData.expirationTime);
                        // Check if the expiration time is in the future
                        if (expirationTime > new Date()) {
                            return true; // Return true if the user is logged in
                        }
                    }
                }
                return false; // Return false if 'userData' is not found or has expired
            }

            // Check if the user is logged in
            if (isLoggedIn()) {
                // Redirect to home page if the user is logged in
                window.location.href = "/";
            }
        }
    </script>
</body>

</html>
